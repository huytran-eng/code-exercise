USE CodeExercise
CREATE TABLE ProblemTags(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	ProblemId UNIQUEIDENTIFIER NOT NULL,
	TagId UNIQUEIDENTIFIER NOT NULL,
	CreatedAt DATETIME NULL,
	CreatedById UNIQUEIDENTIFIER  NULL,
	UpdatedAt DATETIME NULL,
	UpdatedById UNIQUEIDENTIFIER NULL,
	IsDeleted bit NOT NULL DEFAULT 0,
	DeletedAt DATETIME NULL,
	DeletedById UNIQUEIDENTIFIER NULL
	CONSTRAINT Fk_ProblemTags_Problem FOREIGN KEY (ProblemId) REFERENCES Problem(Id),
	CONSTRAINT Fk_ProblemTags_Tag FOREIGN KEY (TagId) REFERENCES Tag(Id),
	CONSTRAINT Fk_ProblemTags_CreatedBy FOREIGN KEY (CreatedById) REFERENCES [User](Id) 
)

CREATE TABLE Contest(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	Title NVARCHAR(255) NOT NULL,
	StartTime DATETIME NOT NULL,
	EndTime DATETIME NOT NULL,
	[Description] NVARCHAR(MAX) NULL,
	MaxParticipants INT NOT NULL,
	CreatedAt DATETIME NULL,
	CreatedById UNIQUEIDENTIFIER  NULL,
	UpdatedAt DATETIME NULL,
	UpdatedById UNIQUEIDENTIFIER NULL,
	IsDeleted bit NOT NULL DEFAULT 0,
	DeletedAt DATETIME NULL,
	DeletedById UNIQUEIDENTIFIER NULL
	CONSTRAINT Fk_Contest_CreatedBy FOREIGN KEY (CreatedById) REFERENCES [User](Id) ,
	CONSTRAINT Fk_Contest_UpdatedBy FOREIGN KEY (UpdatedById) REFERENCES [User](Id) ,
	CONSTRAINT Fk_Contest_DeletedBy FOREIGN KEY (DeletedById) REFERENCES [User](Id) 
)

CREATE TABLE ContestProblem(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	ContestId UNIQUEIDENTIFIER NOT NULL,
	ProblemId UNIQUEIDENTIFIER NOT NULL,
	CONSTRAINT Fk_ContestProblem_Contest FOREIGN KEY (ContestId) REFERENCES [Contest](Id) ,
	CONSTRAINT Fk_ContestProblem_Problem FOREIGN KEY (ProblemId) REFERENCES [Problem](Id) ,
)

CREATE TABLE ProblemContraint(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	Contraint NVARCHAR(1000),
	ProblemId UNIQUEIDENTIFIER NOT NULL, 
	CONSTRAINT Fk_ProblemContraint_ProblemId FOREIGN KEY (ProblemId) REFERENCES [Problem](Id),
)

CREATE TABLE UserSolution(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	Title NVARCHAR(255) NOT NULL,
	Content NVARCHAR(MAX) NOT NULL,
	ProblemId UNIQUEIDENTIFIER NOT NULL, 
	CreatedAt DATETIME NULL,
	CreatedById UNIQUEIDENTIFIER  NULL,
	UpdatedAt DATETIME NULL,
	UpdatedById UNIQUEIDENTIFIER NULL,
	IsDeleted bit NOT NULL DEFAULT 0,
	DeletedAt DATETIME NULL,
	DeletedById UNIQUEIDENTIFIER NULL,
	CONSTRAINT Fk_UserSolution_ProblemId FOREIGN KEY (ProblemId) REFERENCES [Problem](Id),
	CONSTRAINT Fk_UserSolution_CreatedBy FOREIGN KEY (CreatedById) REFERENCES [User](Id) ,
	CONSTRAINT Fk_UserSolutiont_UpdatedBy FOREIGN KEY (UpdatedById) REFERENCES [User](Id) ,
	CONSTRAINT Fk_UserSolution_DeletedBy FOREIGN KEY (DeletedById) REFERENCES [User](Id)
)

CREATE TABLE UserSolutionTag(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	UserSolutionId UNIQUEIDENTIFIER NOT NULL,
	TagId UNIQUEIDENTIFIER NOT NULL,
	CONSTRAINT Fk_UserSolutionTag_UserSolution FOREIGN KEY (UserSolutionId) REFERENCES UserSolution(Id),
	CONSTRAINT Fk_UserSolutionTag_Tag FOREIGN KEY (TagId) REFERENCES Tag(Id),
)

CREATE TABLE Editorial(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	Title NVARCHAR(255) NOT NULL,
	Content NVARCHAR(MAX) NOT NULL,
	ProblemId UNIQUEIDENTIFIER NOT NULL, 
	CreatedAt DATETIME NULL,
	CreatedById UNIQUEIDENTIFIER  NULL,
	UpdatedAt DATETIME NULL,
	UpdatedById UNIQUEIDENTIFIER NULL,
	IsDeleted bit NOT NULL DEFAULT 0,
	DeletedAt DATETIME NULL,
	DeletedById UNIQUEIDENTIFIER NULL,
	CONSTRAINT Fk_Editorial_ProblemId FOREIGN KEY (ProblemId) REFERENCES [Problem](Id),
	CONSTRAINT Fk_Editorial_CreatedBy FOREIGN KEY (CreatedById) REFERENCES [User](Id) ,
	CONSTRAINT Fk_Editorial_UpdatedBy FOREIGN KEY (UpdatedById) REFERENCES [User](Id) ,
	CONSTRAINT Fk_Editorial_DeletedBy FOREIGN KEY (DeletedById) REFERENCES [User](Id)
)

CREATE TABLE EditorialTag(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	EditorialId UNIQUEIDENTIFIER NOT NULL,
	TagId UNIQUEIDENTIFIER NOT NULL,
	CONSTRAINT Fk_EditorialTag_Editorial FOREIGN KEY (EditorialId) REFERENCES Editorial(Id),
	CONSTRAINT Fk_EditorialTag_Tag FOREIGN KEY (TagId) REFERENCES Tag(Id),
)

CREATE TABLE UserSubscription(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	UserId UNIQUEIDENTIFIER NOT NULL,
	SubscriptionType INT NOT NULL,
	StartDate DATETIME NOT NULL,
	EndDate DATETIME NOT NULL,
	CreatedAt DATETIME NULL,
	CreatedById UNIQUEIDENTIFIER  NULL,
	UpdatedAt DATETIME NULL,
	UpdatedById UNIQUEIDENTIFIER NULL,
	IsDeleted bit NOT NULL DEFAULT 0,
	DeletedAt DATETIME NULL,
	DeletedById UNIQUEIDENTIFIER NULL,
	CONSTRAINT Fk_UserSubscription_UserId FOREIGN KEY (UserId) REFERENCES [User](Id),
	CONSTRAINT Fk_UserSubscription_CreatedBy FOREIGN KEY (CreatedById) REFERENCES [User](Id) ,
	CONSTRAINT Fk_UserSubscription_UpdatedBy FOREIGN KEY (UpdatedById) REFERENCES [User](Id) ,
	CONSTRAINT Fk_UserSubscription_DeletedBy FOREIGN KEY (DeletedById) REFERENCES [User](Id)
)

CREATE TABLE ProgrammingLanguage(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	[Name] VARCHAR(20) NOT NULL,
	DisplayName VARCHAR(20) NOT NULL,
	Description NVARCHAR(255) NULL,
	CreatedAt DATETIME NULL,
	CreatedById UNIQUEIDENTIFIER  NULL,
	UpdatedAt DATETIME NULL,
	UpdatedById UNIQUEIDENTIFIER NULL,
	IsDeleted bit NOT NULL DEFAULT 0,
	DeletedAt DATETIME NULL,
	DeletedById UNIQUEIDENTIFIER NULL,
	CONSTRAINT Fk_ProgrammingLanguage_CreatedBy FOREIGN KEY (CreatedById) REFERENCES [User](Id) ,
	CONSTRAINT Fk_ProgrammingLanguage_UpdatedBy FOREIGN KEY (UpdatedById) REFERENCES [User](Id) ,
	CONSTRAINT Fk_ProgrammingLanguage_DeletedBy FOREIGN KEY (DeletedById) REFERENCES [User](Id)
)

ALTER TABLE Problem
	ADD DeletedAt DATETIME NULL,
		DeletedById UNIQUEIDENTIFIER NULL,
		CONSTRAINT FK_Problem_DeletedBy FOREIGN KEY (DeletedById) REFERENCES [User](Id);

ALTER TABLE Problem
	ADD TemplateCode NVARCHAR(MAX) NOT NULL


CREATE TABLE TestCase(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	Input NVARCHAR(1000) NOT NULL,
	ExpectedOutput NVARCHAR(1000) NOT NULL,
	IsHidden BIT NOT NULL DEFAULT 0,
	CreatedAt DATETIME NULL,
	CreatedById UNIQUEIDENTIFIER  NULL,
	UpdatedAt DATETIME NULL,
	UpdatedById UNIQUEIDENTIFIER NULL,
	IsDeleted bit NOT NULL DEFAULT 0,
	DeletedAt DATETIME NULL,
	DeletedById UNIQUEIDENTIFIER NULL,
	CONSTRAINT Fk_TestCase_CreatedBy FOREIGN KEY (CreatedById) REFERENCES [User](Id) ,
	CONSTRAINT Fk_TestCase_UpdatedBy FOREIGN KEY (UpdatedById) REFERENCES [User](Id) ,
	CONSTRAINT Fk_TestCase_DeletedBy FOREIGN KEY (DeletedById) REFERENCES [User](Id)
)

CREATE TABLE UserSubmission(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	Code NVARCHAR(MAX) NOT NULL,
	Memory DECIMAL NOT NULL,
	[Runtime] DECIMAL NOT NULL,
	[Status] DECIMAL NOT NULL,
	Note NVARCHAR(MAX) NOT NULL,
	SubmitDate DATETIME NULL,
	SubmitById UNIQUEIDENTIFIER  NULL,
	CONSTRAINT Fk_UserSubmission_SubmitBy FOREIGN KEY (SubmitById) REFERENCES [User](Id) ,
)

CREATE TABLE UserSubmissionTestCase(
	SubmissionId UNIQUEIDENTIFIER NOT NULL,
	TestCaseId UNIQUEIDENTIFIER NOT NULL,
	[Output] NVARCHAR(1000) NOT NULL,
	[Status] INT NOT NULL DEFAULT 0,
	PRIMARY KEY (SubmissionId, TestCaseId), 
    CONSTRAINT FK_UserSubmissionTestCase_Submission FOREIGN KEY (SubmissionId) REFERENCES UserSubmission(Id) ,
    CONSTRAINT FK_UserSubmissionTestCase_TestCase FOREIGN KEY (TestCaseId) REFERENCES TestCase(Id)
)

CREATE TABLE ContestParticipant(
	UserId UNIQUEIDENTIFIER NOT NULL,
    ContestId UNIQUEIDENTIFIER NOT NULL,
    IsRegistered BIT NOT NULL DEFAULT 1,  
    RegisteredAt DATETIME NOT NULL DEFAULT GETDATE(), 
    PRIMARY KEY (UserId, ContestId),
    CONSTRAINT FK_ContestParticipant_User FOREIGN KEY (UserId) REFERENCES [User](Id) ON DELETE CASCADE,
    CONSTRAINT FK_ContestParticipant_Contest FOREIGN KEY (ContestId) REFERENCES [Contest](Id) ON DELETE CASCADE
)

CREATE TABLE UserContestSubmission(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	ContestId UNIQUEIDENTIFIER NOT NULL, 
	Code NVARCHAR(MAX) NOT NULL,
	Memory DECIMAL NOT NULL,
	[Runtime] DECIMAL NOT NULL,
	[Status] DECIMAL NOT NULL,
	Note NVARCHAR(MAX) NULL,
	SubmitDate DATETIME NULL,
	SubmitById UNIQUEIDENTIFIER  NULL,
	CONSTRAINT Fk_UserContestSubmission_SubmitBy FOREIGN KEY (SubmitById) REFERENCES [User](Id) ,
	CONSTRAINT Fk_UserContestSubmission_Contest FOREIGN KEY (ContestId) REFERENCES Contest(Id) ,
)

CREATE TABLE UserContestSubmissionTestCase(
	UserContestSubmissionId UNIQUEIDENTIFIER NOT NULL,
	TestCaseId UNIQUEIDENTIFIER NOT NULL,
	[Output] NVARCHAR(1000) NOT NULL,
	[Status] INT NOT NULL DEFAULT 0,
	PRIMARY KEY (UserContestSubmissionId, TestCaseId), 
    CONSTRAINT FK_UserContestSubmissionTestCase_Submission FOREIGN KEY (UserContestSubmissionId) REFERENCES UserContestSubmission(Id) ,
    CONSTRAINT FK_UserContestSubmissionTestCase_TestCase FOREIGN KEY (TestCaseId) REFERENCES TestCase(Id)
)

